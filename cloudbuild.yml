
steps:
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'southamerica-west1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/qembeddings/qembeddings:$COMMIT_SHA', '.']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'southamerica-west1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/qembeddings/qembeddings:$COMMIT_SHA']
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args: 
      - 'run'
      - 'deploy'
      - 'qembeddings'
      - '--image'
      - 'southamerica-west1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/qembeddings/qembeddings:$COMMIT_SHA'
      - '--region'
      - 'southamerica-west1'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--service-account'
      - '244469163250-compute@developer.gserviceaccount.com'
      - '--set-env-vars'
      - 'HF_TOKEN=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'
      - '--timeout'
      - '3600'
      - '--cpu'
      - '2'
      - '--memory'
      - '2Gi'
      - '--concurrency'
      - '80'
      - '--max-instances'
      - '2' 
      - '--port'
      - '4500'
      - '--mount-volume'  # Mount the volume for /app/static
      - 'name=static-volume,path=/app/static'

# Add volumes section (adjust volume configuration as needed)
volumes:
  - name: 'static-volume'
    # ... (e.g., Cloud Storage bucket, persistent disk)

# Substitutions (use Cloud Build variable for the SHA)
substitutions:
  _PROJECT_ID: 'intaas-880b3' # Replace with your project ID
volumes:
  - name: 'static-volume'
    cloudStorageBucket: 'qollqa'